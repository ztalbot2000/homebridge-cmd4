#!/usr/bin/env node

// Note:
// Must read https://docs.github.com/en/rest/reference/markdown#render-an-arbitrary-markdown-document
// https://gist.github.com
//
// Good Learning sites:
// https://www.w3schools.com/jquery/jquery_get_started.asp
// https://www.w3schools.com/howto/howto_css_sidebar_icons.asp
//
// Node.js Manuals & Documentation
// https://nodejs.org/docs/v0.4.0/api/all.html

//            * Cmd4 Body Layout *
//            ====================
//
//    =====================================
//   | class="header fixed-top"
//   |  __________________________________
//   | | class="container-fluid"
//   | |  _______________________________
//   | | | class="site-logo"
//   | | |_______________________________
//   | | | Search - tba
//   | | |_______________________________
//   | |__________________________________
//   |
//   |=====================================
//   | class="content"
//   |  _________________________________
//   | | class="sidenav"
//   | |  - device links
//   | |  - characteristic links
//   | |  - cmd4Directive links
//   | |   .
//   | |   .
//   | |   .
//   | |_________________________________
//   | | class="main"
//   | | - class="section" - device pages
//   | | - class="section" - characteristic pages
//   | | - class="section" - directive pages
//   | |   .
//   | |   .
//   | |   .
//   | |_________________________________
//   |=====================================
//   | Javascript
//    =====================================



//                * HTML Layout *
//                ===============
//    _______________________________________
//   |                 Margin                |
//   |   _________________________________   |
//   |  |              Border             |  |
//   |  |   ___________________________   |  |
//   |  |  |           Padding         |  |  |
//   |  |  |   _____________________   |  |  |
//   |  |  |  |                     |  |  |  |
//   |  |  |  |        Content      |  |  |  |
//   |  |  |  |_____________________|  |  |  |
//   |  |  |                           |  |  |
//   |  |  |___________________________|  |  |
//   |  |                                 |  |
//   |  |_________________________________|  |
//   |                                       |
//   |_______________________________________|



const which = require('which');
const path = require( "path" );

const settings = require( "../cmd4Settings" );

// Get the real path of homebridge instead of a dev dependancy,
// which caused issues if you forget to update dependancies but
// upgrade homebridge.
const homebridgePath = which.sync( 'homebridge', { nothrow: true } )

let apiPath;
let HomebridgeAPI;
if ( homebridgePath )
{
   let dirname = path.dirname( homebridgePath );

   console.log( "Found homebridge in path %s", dirname );
   apiPath = `${ dirname }/../lib/node_modules/homebridge/lib/api`;
   HomebridgeAPI = require( apiPath ).HomebridgeAPI;

   if ( ! HomebridgeAPI )
   {
      console.log( "homebridgeAPI not available !!!" );
      process.exit( 10 );
   }

} else
{
   console.log( "homebridge not found !!!" );
   process.exit( 10 );
}
console.log( "Found api in %s", apiPath );



// Cmd4 Constants and Settings
const constants = require( "../cmd4Constants" );
//const settings = require( "../cmd4Settings" );

// For changing validValue Constants to Values and back again
var { transposeValueToValidConstant } = require( "../utils/transposeCMD4Props" );

// Required to initialize CMD4 Accessory & Device lookup tables.
let _api = new HomebridgeAPI( ); // object we feed to Plugins


// These would be the uninitialized values.
let ACC_DATA = require('../lib/CMD4_ACC_TYPE_ENUM');
let DEVICE_DATA = require('../lib/CMD4_DEVICE_TYPE_ENUM');

// Init the library for all to use
let CMD4_ACC_TYPE_ENUM = ACC_DATA.init( _api.hap.Characteristic );
let CMD4_DEVICE_TYPE_ENUM = DEVICE_DATA.init( CMD4_ACC_TYPE_ENUM, _api.hap.Service, _api.hap.Characteristic, _api.hap.Categories );
let Characteristic = _api.hap.Characteristic;

// File System utilities
let fs = require( "fs" );

let CMD4_DOC_FILE_PATH = "./docs/";
let AUTO_GENERATED_SUB_PATH = "autoGenerated/";
let CMD4_ACC_DOC_FILE = "CMD4_AccessoryDescriptions.html";

// Scripts we embed
let CMD4_SCRIPTS = [
   { "file": "ExampleJavaScript_template.js",
     "filePath": "./Extras/Cmd4Scripts/Examples/",
     "link": "JS Template",
     "description": "Example Cmd4 JavaScript Template"
   },
   { "file": "ExampleShellScript_template.sh",
     "filePath": "./Extras/Cmd4Scripts/Examples/",
     "link": "Bash Template",
     "description": "Example Cmd4 Shell Script Template"
   }
];

// The fid of the document.
var fid;

var divLevel=0;
const INDENT = 3;

// Since v6.2 the Accessory characteristics are not sorted. This
// is because peoples saved status per characteristic is done by index.
// changing this would mean the values would be mixed up.
function sortACCByType( )
{
   var keysAndIndexes = [];
   var sorted_obj = { properties: [],
                      indexOfEnum: CMD4_ACC_TYPE_ENUM.indexOfEnum,
                      EOL: CMD4_ACC_TYPE_ENUM.EOL
                    };
   let characteristicNames = [];
   let characteristicName = "";

   for ( let accTypeEnumIndex = 0 ; accTypeEnumIndex < CMD4_ACC_TYPE_ENUM.EOL; accTypeEnumIndex++ )
   {
      // Set the old characteristic name and value
      characteristicName = Object.keys(CMD4_ACC_TYPE_ENUM).find(key => CMD4_ACC_TYPE_ENUM[key] === accTypeEnumIndex );
      characteristicNames.push( characteristicName );

      keysAndIndexes.push( { "key": CMD4_ACC_TYPE_ENUM.properties[ accTypeEnumIndex ].type, "index": accTypeEnumIndex }  );
   }

   // sort the keys ( types )
   keysAndIndexes.sort( function(a, b)
   {
      //return a.key < b.key;
      if  (a.key < b.key) return -1
      return a.key > b.key ? 1:0
   });

   // create new array based on Sorted Keys
   for ( let index = 0 ; index < keysAndIndexes.length; index++ )
   {
      let pair = keysAndIndexes[ index ];
      let oldIndex = pair.index;
      sorted_obj.properties[index] = CMD4_ACC_TYPE_ENUM.properties[oldIndex];

      characteristicName = pair.key;
      // This would be the new index
      sorted_obj[ characteristicName ] = index;
   }

   return sorted_obj;
}

// Since v6.2 the Device names are not sorted. This
// is because I'm lazy to change any documentation referencing an index
function sortDevByDeviceName( )
{
   var keysAndIndexes = [];
   var sorted_obj = { properties: [],
                      indexOfEnum: CMD4_DEVICE_TYPE_ENUM.indexOfEnum,
                      EOL: CMD4_DEVICE_TYPE_ENUM.EOL
                    };

   let deviceNames = [];
   let deviceName = "";

   for ( let devTypeEnumIndex = 0 ; devTypeEnumIndex < CMD4_DEVICE_TYPE_ENUM.EOL; devTypeEnumIndex++ )
   {
      // Set the old device name and value
      deviceName = Object.keys(CMD4_DEVICE_TYPE_ENUM).find(key => CMD4_DEVICE_TYPE_ENUM[key] === devTypeEnumIndex );
      deviceNames.push( deviceName );

      keysAndIndexes.push( { "key": CMD4_DEVICE_TYPE_ENUM.properties[ devTypeEnumIndex ].deviceName, "index": devTypeEnumIndex }  );
   }

   // sort the keys ( deviceName )
   keysAndIndexes.sort( function(a, b)
   {
      //return a.key < b.key;
      if  (a.key < b.key) return -1
      return a.key > b.key ? 1:0
   });

   // create new array based on Sorted Keys
   for ( let index = 0 ; index < keysAndIndexes.length; index++ )
   {
      let pair = keysAndIndexes[ index ];
      let oldIndex = pair.index;
      sorted_obj.properties[index] = CMD4_DEVICE_TYPE_ENUM.properties[oldIndex];

      deviceName = pair.key;
      // This would be the new index
      sorted_obj[ deviceName ] = index;
   }

   return sorted_obj;
}

let CMD4_Sorted_ACC = sortACCByType( );
let CMD4_Sorted_DEV = sortDevByDeviceName( );


function createHTMLCmd4AccDocument( )
{
   let file = CMD4_DOC_FILE_PATH +
              AUTO_GENERATED_SUB_PATH +
              CMD4_ACC_DOC_FILE;

   // Open the document for writing
   fid = fs.createWriteStream( file,
          { flags: "w" // Open for write
        });

   fid.on("error", ( ) =>
   {
      console.log(`error fs.creatingWriteStream: ${ file }` );
      process.exit( 666 );
   });

   startHTML_AndHead( );

   addSytlesAndLeftSideNav_WithinHead ( );
   endHead( );

   addBody( );

   wfs( `</HTML>\n` );

   fid.close( );

}

function startHTML_AndHead ()
{
   wfs(
`<!DOCTYPE HTML>
<HTML LANG="en">
<HEAD>
<META CHARSET="utf-8">
<META NAME="viewport" CONTENT="width=device-width, initial-scale=1">
<!-- Needed for unicode fa-caret-down -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<META NAME="robots" CONTENT="index,follow">
<META NAME="Description" CONTENT="CMD4 Characteristics.">
<META PROPERTY="og:url" CONTENT="https://github.com/ztalbot2000/homebridge-cmd4/docs/${ AUTO_GENERATED_SUB_PATH }${ CMD4_ACC_DOC_FILE }">

<TITLE>CMD4 Devices</TITLE>\n` );

}

function addSytlesAndLeftSideNav_WithinHead( )
{
   wfs(
`<META NAME="viewport" CONTENT="width=device-width, initial-scale=1">
<STYLE>

/* Fallback styling */
BODY {
   font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;
   font-size: 1rem;
   font-weight: 400;
   line-height: 1.5;
   color: #252930;          /* blackish */
   text-align: left;
   background-color: white;
}

/* Common styling used inline */
.fixed-bottom, .fixed-top {
   POSITION: fixed;
   LEFT: 0;
   z-index: 1030;
   background-color: white;
}
.fixed-top {
   TOP: 0;
}
.position-relative {
   position: relative;
}
.float-left {
   float: left;
}
.flex {
   display: flex;
}
.align-items-center {
   align-items: center;
}


.header {
   /* The header div goes all across the top */
   WIDTH: 100%;
   box-shadow: 0 1px 4px 0 rgba(0,0,0,.1);
}

/* This houses the Logo */
.container-fluid {
   width: 100%;
   padding-right:15px;
   padding-left:15px;
   margin-right:auto;
   margin-left:auto;
}


.site-logo {
  box-shadow: 0 1px 4px 0 rgba(0,0,0,.1);
  BACKGROUND: white;
  display: inline-block;
}
.site-text {
  BACKGROUND: white;
  position: relative;
  display: inline-block;
  transform: translate( 0, 25% );
}

.nav-link:before {
   background-color: #fbf5ff;
   content: " ";
   display: inline-block;
   height: inherit;
   left: 0;
   margin-top: -.5rem;
   position: absolute;
   width: 3px;
   height: 100%;
   border-radius: 1rem;
}

/* Fixed sidenav */
.sidenav
{
  WIDTH: 130px;
  POSITION: fixed;
  Z-INDEX: 1;
  MARGIN-LEFT: 10px;
  /* Must be below Logo */
  MARGIN-TOP: 50px;
  BACKGROUND: #eee;
  OVERFLOW-X: hidden;
  OVERFLOW-Y: auto;
  max-height: calc( 100vh - 9rem);
}

/* Style the sidenav links and the dropdown button */
.sidenav a, .dropdown-btn, .accordion {
  PADDING: 6px 8px 6px 16px;  /* Top, Right, Bottom,Left */
  TEXT-DECORATION: none;
  FONT: 10.5px Poppins;
  COLOR: #4b5465;           /* Blueish Gray */
  DISPLAY: block;
  -webkit-text-stroke: #4b546;
  TEXT-ALIGN: left;
  CURSOR: pointer;
  OUTLINE: none;
  BACKGROUND: none;
  /* Border around button */
  BORDER: none;
}

/* On mouse-over */
.sidenav a:hover, .dropdown-btn: hover, .accordion: hover
{
  COLOR: #064579;   /* darker blue */
}

.accordion
{
  transition: 0.4s;
}

/* accordion type divs */
.panel {
  padding: 0 0px;
  display: none;
  background-color: white;
  overflow: hidden;
}

.main {
  MARGIN-LEFT: 148px; /* Same width as the sidebar + left position in px */
  PADDING: 55px 10px; /* Top, Right, Bottom, Left */
}

/* Div within main, holding page information */
/* This is also used to hide all the sections at startup */
.section {
  display: none; /* initially hidden */
}

/* Common paragraph sytling */
h1 {
   FONT-SIZE: 2.5rem;
   padding-top: 4rem;
}
h2 {
   FONT-SIZE: 1.5rem;
}
h1, h2, h3, h4, h5 {
  COLOR: #252930;
  FONT-WEIGHT: 600;
}
h1, h2, h3, h4, h5, note, p {
   FONT-FAMILY: Poppins,sans-serif;
   MARGIN-TOP: 0;
   MARGIN-BOTTOM: .5rem;
   font-weight: 500;
   line-height: 1.2;
}
note {
   FONT-STYLE: italic;
   FONT-SIZE: 1rem;
   COLOR: #5d6778;   /* blue-ish gray */
   PADDING: 2rem;
}


/* Table styling */
table {
   display: table;
   border-collapse: collapse;
   -webkit-border-horizontal-spacing: 2px;
   -webkit-border-vertical-spacing: 2px;
   width: 100%;
   margin-bottom: 1rem;
}
th {
   FONT-WEIGHT: bold;
   border: 1px solid #e7e9ed;
   text-align: center;
}
td {
   padding: .75rem;
   vertical-align: top;
   border-top: 1px solid #e7e9ed;
   FONT-WEIGHT: normal;
}
tr:nth-child(even) { background-color: #f2f2f2 }  /* off white */

block-warning a {
   color: #d09c13;     /* Orange-ish */
}

/* Add an active class to the active dropdown button */
.active, .accordion: hover {

  /* The background color of the active buttons */
  background-color: #ccc;   /* light gray */

  /* The width of item is the width of the div */
  /* Otherwise buttons appear half blocked */
  width: 100%;
}

/* Optional: Style the caret down icon */
.fa-caret-down {
  float: right;
}

/* Apply box-sizing to everything */
* {
   box-sizing: border-box;
}

/* Some media queries for responsiveness */
@media screen and (max-height: 450px) {
  .sidenav {PADDING-TOP: 15px;}
  .sidenav a {FONT-SIZE: 12px;}  /* height of items in accordion dropdown */
}
</STYLE>\n` );

}
function endHead( )
{
   wfs( `</HEAD>\n` );
}

function addBody ()
{
   wfs( `<BODY>\n` );

   addFixedHeader_WithinBody();

   addContentDiv_WithinBody( );

   addAccordionScript_WithinEndOfBody();

   addDropDownScript_WithinEndOfBody();

   addToggleVisibilityScript_WithinEndOfBody( );

   wfs( `</BODY>\n` );
}

function addFluidHeader_WithinFixedHeader()
{
   wf( "+", `<div class="container-fluid position-relative">\n` );

      addLogoDiv_WithinFluidHeader( );

   endDiv( "container-fluid" );
}
function addFixedHeader_WithinBody()
{
   wf( "+", `<HEADER class="header fixed-top">\n` );

      addFluidHeader_WithinFixedHeader();

   wf( "-", `</HEADER>\n` );
}


function addContentDiv_WithinBody( )
{
   wf( "+", `<div class="content">\n` );

      addSideNav_WithinContentDiv( )

      addIntroductionPage_WithinContentDiv( )

      addMain_withinContentDiv( );

   endDiv( "content" );

}
function addMain_withinContentDiv( )
{
   wf( "+", `<div class="main">\n` );

      addDevicePages_WithinMain( )

      addCharacteristicPages_WithinMain( );

      addCmd4DirectivePages_WithinMain( );

      addCmd4AccessoryDirectivePages_WithinMain( );

      addCustomCharacteristicPages_withinMain( );

      addScriptTemplatePages_WithinMain( );

   endDiv( "main" );
}


function addLogoDiv_WithinFluidHeader( )
{
   wf( "+", `<div class="site-logo">\n` );

      wfs( `<img class="float-left" src="assets/images/Cmd4_icon.svg" width="40px" alt="logo">\n` );

      wf( "+", `<div class="site-text">\n` );
        wfs(`Cmd4\n`);
      endDiv( "site-text" );

   endDiv( "site-logo" );
}

// For this to work, it must be at the end of the Body
function addAccordionScript_WithinEndOfBody( )
{
   wf( "+", `<script>\n` );
   wfs(
`var acc = document.getElementsByClassName("accordion");
var i;

for (i = 0; i < acc.length; i++) {
  acc[i].addEventListener("click", function() {
    this.classList.toggle("active");
    var panel = this.nextElementSibling;
    if (panel.style.display === "block") {
      panel.style.display = "none";
    } else {
      panel.style.display = "block";
    }
  });
}
` );
   wf( "-", `</script>\n` );
}

// For this to work, it must be at the end of the Body
function addToggleVisibilityScript_WithinEndOfBody( )
{
   wf( "+", `<script type="text/javascript">\n` );
   wfs(
`
function toggleVisibility( id )
{
   var e = document.getElementById( id );
   /* Hide the last one off */
   if ( window.lastToggledE !== undefined )
   {
      window.lastToggledE.style.display = "none";
   }

   /* Show the new one on */
   if ( e.style.display = "none" )
   {
      e.style.display = "block";
   }

   /* Set the last one to this one */
   window.lastToggledE = e;
}
` );
   wf( "-", `</script>\n` );
}

// For this to work, it must be at the end of the Body
function addDropDownScript_WithinEndOfBody( )
{
   wf( "+", `<script>\n` );
   wfs( `
// Loop through all dropdown buttons to toggle between hiding and
// showing its dropdown content - This allows the user to have
// multiple dropdowns without any conflict

var dropdown = document.getElementsByClassName("dropdown-btn");

for (let i = 0; i < dropdown.length; i++)
{
  dropdown[i].addEventListener("click", function()
  {
     this.classList.toggle("active");
     var dropdownContent = this.nextElementSibling;
     if (dropdownContent.style.display === "block")
     {
        dropdownContent.style.display = "none";
     } else {
        dropdownContent.style.display = "block";
     }
  });
}\n` );

   wf( "-", `</script>\n` );

}

function addSideNav_WithinContentDiv( )
{
   wf( "+", `<div class="sidenav">\n` );

      addSideNavIntroductionLinks_WithinSideNav ();

      addSideNavDevicesLinks_WithinSideNav( );

      addSideNavCharacteristicsLinks_WithinSideNav( );

      addSideNavCmd4DirectivesLinks_WithinSideNav( );

      addSideNavCmd4AccessoryDirectivesLinks_WithinSideNav( );

      addSideNavCustomCharacteristicsLinks_WithinSideNav( );

      addSideNavScriptTemplateLinks_WithinSideNav( );

      wfs( `<a href=https://github.com/ztalbot2000/homebridge-cmd4/blob/master/docs/Developers.md>Developers Guide</a>\n` );

      wfs( `<a href=https://github.com/ztalbot2000/homebridge-cmd4/blob/master/docs/AdvancedTroubleShooting.md>Advanced TroubleShooting</a>\n` );

   endDiv( "sidenav" );
}
function addSideNavDevicesLinks_WithinSideNav( )
{

   // Accordion button for Devices
   wf( "+", `<button class="accordion">Devices\n` );
      wfs( `<i class="fa fa-caret-down"></i>\n` );
   wf( "-", `</button>\n` );


   wf( "+", `<div class="panel">\n` );

      for ( let index=0; index < CMD4_DEVICE_TYPE_ENUM.EOL; index ++)
      {
         // We just need the index to look sorted
         let deviceName = CMD4_Sorted_DEV.properties[ index ].deviceName;

         wfs( `<a href="#${ deviceName }" onclick="toggleVisibility( '${ deviceName }');">${ deviceName }</a>\n` );
      }

   endDiv( "panel" );
}
function addSideNavIntroductionLinks_WithinSideNav ()
{
}

function addSideNavCharacteristicsLinks_WithinSideNav( )
{
   // Accordion button for Characteristics
   wf( "+", `<button class="accordion">Characteristics\n` );
      wfs( `<i class="fa fa-caret-down"></i>\n` );
   wf( "-", `</button>\n` );


   wf( "+", `<div class="panel">\n` );
      // We just need the index to look sorted
      for ( let index=0; index < CMD4_ACC_TYPE_ENUM.EOL; index ++)
      {
         // Lower case characteristic
         let characteristic = CMD4_Sorted_ACC.properties[ index ].sche;

         wfs( `<a href="#${ characteristic }" onclick="toggleVisibility( '${ characteristic }');">${ characteristic }</a>\n` );
      }
   endDiv( "panel" );

}
function addSideNavCmd4DirectivesLinks_WithinSideNav( )
{
   // Accordion button for Directives
   wf( "+", `<button class="accordion">Directives\n` );
      wfs( `<i class="fa fa-caret-down"></i>\n` );
   wf( "-", `</button>\n` );

   wf( "+", `<div class="panel">\n` );
      wfs( `<a href="#${ constants.DEBUG }_D" onclick="toggleVisibility( 'Directives');">${ constants.DEBUG }</a>\n` );
      wfs( `<a href="#${ constants.OUTPUTCONSTANTS }_D" onclick="toggleVisibility( 'Directives');">${ constants.OUTPUTCONSTANTS }</a>\n` );
      wfs( `<a href="#${ constants.STATUSMSG }_D" onclick="toggleVisibility( 'Directives');">${ constants.STATUSMSG }</a>\n` );
      wfs( `<a href="#${ constants.INTERVAL }_D" onclick="toggleVisibility( 'Directives');">${ constants.INTERVAL }</a>\n` );
      wfs( `<a href="#${ constants.TIMEOUT }_D" onclick="toggleVisibility( 'Directives');">${ constants.TIMEOUT }</a>\n` );
      wfs( `<a href="#${ constants.QUEUETYPES }_D" onclick="toggleVisibility( 'Directives');">${ constants.QUEUETYPES }</a>\n` );
      wfs( `<a href="#${ constants.DEFINITIONS }_D" onclick="toggleVisibility( 'Directives');">${ constants.DEFINITIONS }</a>\n` );
   endDiv( "panel" );

}

function addSideNavCmd4AccessoryDirectivesLinks_WithinSideNav( )
{
   // Accordion button for Characteristics
   wf( "+", `<button class="accordion">Accessory Directives\n` );
      wfs( `<i class="fa fa-caret-down"></i>\n` );
   wf( "-", `</button>\n` );


   wf( "+", `<div class="panel">\n` );
      wfs( `<a href="#${ constants.SUBTYPE }" onclick="toggleVisibility( 'AccessoryDirectives');">${ constants.SUBTYPE }</a>\n` );
      wfs( `<a href="#${ constants.FAKEGATO }" onclick="toggleVisibility( 'AccessoryDirectives');">${ constants.FAKEGATO }</a>\n` );
      wfs( `<a href="#${ constants.PUBLISHEXTERNALLY }" onclick="toggleVisibility( 'AccessoryDirectives');">${ constants.PUBLISHEXTERNALLY }</a>\n` );
      wfs( `<a href="#${ constants.STATE_CMD_PREFIX }" onclick="toggleVisibility( 'AccessoryDirectives');">${ constants.STATE_CMD_PREFIX }</a>\n` );
      wfs( `<a href="#${ constants.STATE_CMD_SUFFIX }" onclick="toggleVisibility( 'AccessoryDirectives');">${ constants.STATE_CMD_SUFFIX }</a>\n` );
      wfs( `<a href="#${ constants.STATE_CMD }" onclick="toggleVisibility( 'AccessoryDirectives');">${ constants.STATE_CMD }</a>\n` );
      wfs( `<a href="#${ constants.POLLING }" onclick="toggleVisibility( 'AccessoryDirectives');">${ constants.POLLING }</a>\n` );
      wfs( `<a href="#${ constants.INTERVAL }" onclick="toggleVisibility( 'AccessoryDirectives');">${ constants.INTERVAL }</a>\n` );
      wfs( `<a href="#${ constants.TIMEOUT }" onclick="toggleVisibility( 'AccessoryDirectives');">${ constants.TIMEOUT }</a>\n` );
      wfs( `<a href="#${ constants.QUEUE }" onclick="toggleVisibility( 'AccessoryDirectives');">${ constants.QUEUE }</a>\n` );
      wfs( `<a href="#${ constants.STATECHANGERESPONSETIME }" onclick="toggleVisibility( 'AccessoryDirectives');">${ constants.STATECHANGERESPONSETIME }</a>\n` );
      wfs( `<a href="#${ constants.LINKEDTYPES }" onclick="toggleVisibility( 'AccessoryDirectives');">${ constants.LINKEDTYPES }</a>\n` );
      wfs( `<a href="#${ constants.OUTPUTCONSTANTS }" onclick="toggleVisibility( 'AccessoryDirectives');">${ constants.OUTPUTCONSTANTS }</a>\n` );
      wfs( `<a href="#${ constants.STATUSMSG }" onclick="toggleVisibility( 'AccessoryDirectives');">${ constants.STATUSMSG }</a>\n` );
   endDiv( "panel" );

}

function addSideNavCustomCharacteristicsLinks_WithinSideNav( )
{
   // Accordion button for Characteristics
   wf( "+", `<button class="accordion">Custom Characteristics\n` );
      wfs( `<i class="fa fa-caret-down"></i>\n` );
   wf( "-", `</button>\n` );

   wf( "+", `<div class="panel">\n` );
      wfs( `<a href="#CUSTOM_CHARACTERISTICS" onclick="toggleVisibility( 'CustomCharacteristics');">Custom Characteristics</a>\n` );
   endDiv( "panel" );
}

function addSideNavScriptTemplateLinks_WithinSideNav( )
{
   // Accordion button for ScriptTemplates
   wf( "+", `<button class="accordion">Script Templates\n` );
      wfs( `<i class="fa fa-caret-down"></i>\n` );
   wf( "-", `</button>\n` );

   wf( "+", `<div class="panel">\n` );

      CMD4_SCRIPTS.forEach( ( script ) =>
      {
         //wfs( `<a href="#${ script.link }">${ script.link }</a>\n` );
         wfs( `<a href="#${ script.link }" onclick="toggleVisibility( '${ script.link }');">${ script.link }</a>\n` );
      });

   endDiv( "panel" );

}

function addIntroductionPage_WithinContentDiv( )
{
   wf( "+", `<div class="main">\n` );
   wfs( `<h2>CMD4 Portal</h2>\n` );
   wfs( `<p>This auto generated document replaces much of the hard coded definitions and is the portal to everything that is Cmd4.</p>\n` );
   wfs( `<p>Enjoy</p>\n` );
   wfs( `<p>&nbsp;&nbsp;&nbsp;John Talbot</p>\n` );

   endDiv( "main" );
}

function addDevicePages_WithinMain( )
{
   //wfs( `<h2>CMD4 Device Properties</h2>\n` );
   //wfs( `<p>This auto generated document replaces the hard coded, impossible to maintain definitions in what was the State.js script and other locations.</p>\n` );

   for ( let index=0; index < CMD4_DEVICE_TYPE_ENUM.EOL; index ++)
   {
      let deviceName = CMD4_DEVICE_TYPE_ENUM.properties[ index ].deviceName;

      addSingleDeviceContent( index, deviceName );
   }

}

function addSingleDeviceContent(device_type_enum, deviceName )
{
   let definition = CMD4_DEVICE_TYPE_ENUM.properties[ device_type_enum ];
   let requiredCharacteristics = definition.requiredCharacteristics;
   let optionalCharacteristics = definition.optionalCharacteristics;
   let defaultPollingCharacteristics = definition.defaultPollingCharacteristics;
   let commaNeeded = true;

   // Start deviceName Div
   // The <div id> is used to show/hide the section.
   // The <class> is used for css formatting, including initial hide.
   // The <a name> is used to jump here when nav item clicked.
   wf( "+", `<div id="${ deviceName }" class="section">\n` );
   wfs( `<a name="${ deviceName }"></a>\n` );
   wfs( `<header><h1>${ deviceName }</h1></header>\n` );
   wfs( `<p>UUID:${ definition.UUID }</p>\n` );

   // Required Characteristics
   wfs( `<H3>Required Characteristics</H3>\n` );
   if ( requiredCharacteristics && requiredCharacteristics.length > 0 )
   {
      wf( "+", `<table>\n` );
      wfs( `<TD> </TD><TD> Default Value </TD><TD> Constant </TD>\n` );

      requiredCharacteristics.forEach( ( characteristic ) =>
      {
         // Look up the characteristic index given, to its string value
         let characteristicString = CMD4_ACC_TYPE_ENUM.properties[ characteristic.type ].sche;
         let defaultValue = characteristic.defaultValue;

         let transposed = transposeValueToValidConstant( CMD4_ACC_TYPE_ENUM.properties, characteristic.type, defaultValue );

         if ( transposed == defaultValue )
            transposed = "n/a";

         wfs( `<tr><TD><UL><LI><a href="#${ characteristicString }">${ characteristicString }</a></UL></TD><TD> ${ defaultValue } </TD><TD> ${ transposed } </TD>\n` );
      });
      wf( "-", `</Table>\n` );
   }


   // Optional Characteristics
   wfs( `<H3>Optional Characteristics</H3>\n` );
   if ( optionalCharacteristics && optionalCharacteristics.length > 0 )
   {
      wf( "+", `<UL>\n` );
      optionalCharacteristics.forEach( ( characteristic ) =>
      {
         let characteristicString = CMD4_ACC_TYPE_ENUM.properties[ characteristic ].sche;
        wfs( `<LI><a href="#${ characteristicString }">${ characteristicString }</a>\n` );
      });
      wf( "-", `</UL>\n` );
   }

   // Default Polling  Characteristics
   if ( defaultPollingCharacteristics && defaultPollingCharacteristics.length > 0 )
   {
      wfs( `<H3>Default Polling Characteristics</H3>\n` );
      wfs( `<note> Default polling characteristics are characteristics that would automatically be polled if Accessory Polling is configured ( polling:true ) instead of characteristic polling where each characteristic is set individually.\n` );
      wf( "+", `<UL>\n` );

      defaultPollingCharacteristics.forEach( ( characteristic ) =>
      {
         let characteristicString = CMD4_ACC_TYPE_ENUM.properties[ characteristic ].sche;
         wfs( `<LI><a href="#${ characteristicString }">${ characteristicString }</a>\n` );
      });

      wf( "-", `</UL>\n` );
   }
   wfs( `<H3>Example config.json entry</H3>\n` );
   commaNeeded = true;

   // This is pre-formatted text
   wfs( `<pre>\n` );

   // The stuff in the brace will be indented
   wf( "+", `{\n` );
   wfs( `${ constants.TYPE }: ${ definition.deviceName },\n` );
   let nameCharacteristicString = CMD4_ACC_TYPE_ENUM.properties[ CMD4_ACC_TYPE_ENUM.Name ].sche;
   wfs( `${ nameCharacteristicString }: "MY_${ definition.deviceName }",\n` );
   wfs( `${ constants.DISPLAYNAME }: "MY_${ definition.deviceName }"` );
   if ( requiredCharacteristics && requiredCharacteristics.length > 0 )
   {
      requiredCharacteristics.forEach( ( characteristic ) =>
      {
         let requiredDefinition = CMD4_ACC_TYPE_ENUM.properties[ characteristic.type ];
         if ( commaNeeded )
            w( `,\n` );

         // Look up the characteristic index given, to its string value
         let characteristicString = requiredDefinition.sche;
         let defaultValue = characteristic.defaultValue;
         wfs( `${ characteristicString }: "${ defaultValue}"` );
      });
   }

   if ( optionalCharacteristics && optionalCharacteristics.length > 0 )
   {
      optionalCharacteristics.forEach( ( characteristic ) =>
      {
         let optionalDefinition = CMD4_ACC_TYPE_ENUM.properties[ characteristic ];
         let characteristicString = optionalDefinition.sche;

         if ( optionalDefinition.type == CMD4_ACC_TYPE_ENUM.Name )
            return;

         // Do not show TLV8 characteristics
         let format = optionalDefinition.props.format;
         switch( format )
         {
            case Characteristic.Formats.TLV8:
               return;
            case Characteristic.Formats.INT:
               if ( commaNeeded ) w( `,\n` );
               wfs( `${ characteristicString }: < INT >` );
               break;
            case Characteristic.Formats.UINT8:
               if ( commaNeeded ) w( `,\n` );
               wfs( `${ characteristicString }: < UINT8 >` );
               break;
            case Characteristic.Formats.UINT16:
               if ( commaNeeded ) w( `,\n` );
               wfs( `${ characteristicString }: < UINT16 >` );
               break;
            case Characteristic.Formats.UINT32:
               if ( commaNeeded ) w( `,\n` );
               wfs( `${ characteristicString }: < UINT32 >` );
               break;
            case Characteristic.Formats.UINT64:
               if ( commaNeeded ) w( `,\n` );
               wfs( `${ characteristicString }: < UINT64 >` );
               break;
            case Characteristic.Formats.STRING:
               if ( commaNeeded ) w( `,\n` );
               wfs( `${ characteristicString }: "< STRING> "` );
               break;
            case Characteristic.Formats.BOOL:
               if ( commaNeeded ) w( `,\n` );
               wfs( `${ characteristicString }: < BOOLEAN >` );
               break;
            case Characteristic.Formats.ARRAY:
               if ( commaNeeded ) w( `,\n` );
               wfs( `${ characteristicString }: < ARRAY >` );
               break;
            case Characteristic.Formats.DATA:
               if ( commaNeeded ) w( `,\n` );
               wfs( `${ characteristicString }: < DATA >` );
               break;
            case Characteristic.Formats.DICTIONARY:
               if ( commaNeeded ) w( `,\n` );
               wfs( `${ characteristicString }: < DICTIONARY >` );
               break;
            default:
               if ( commaNeeded ) w( `,\n` );
               wfs( `Unknown format ${ format }` );
         }
      });
   }

   if ( commaNeeded ) w( `,\n` );
      wfs( `<a href="#${ constants.STATE_CMD }">${ constants.STATE_CMD }</a>: < "STRING" >,\n` );
   wfs( `<a href="#${ constants.POLLING }">${ constants.POLLING }</a>: < POLLING>\n` );
   // The last carriage return before the close brace
   w( `\n` );

   // End of the indented stuff in the brace
   wf( "-", `}\n` );

   // End of pre-formatted text
   wfs( `</pre>\n` );

   wfs( `See additional <a href="#CMD4 Accessory Directives">CMD4 Accessory Directives</a>\n` );

   endDiv( deviceName );
}

function addCharacteristicPages_WithinMain( )
{
   //
   // Add the characteristic content within the HTML body
   //
   for ( let index=0; index < CMD4_ACC_TYPE_ENUM.EOL; index ++)
   {
      let characteristic = CMD4_ACC_TYPE_ENUM.properties[ index ].sche;

      addSingleCharacteristicContent( index, characteristic );

   }
}

function addSingleCharacteristicContent( acc_type_enum, characteristic )
{
   let definition = CMD4_ACC_TYPE_ENUM.properties[ acc_type_enum ];
   let props = CMD4_ACC_TYPE_ENUM.properties[ acc_type_enum ].props;

   // Start characteristic div
   // The <div id> is used to show/hide the section.
   // The <class> is used for css formatting, including initial hide.
   // The <a name> is used to jump here when nav item clicked.
   wf( "+", `<div id="${ characteristic }" class="section" >\n` );
   wfs( `<a name="${ characteristic }"></a>\n` );
   wfs( `<header><h1>${ characteristic }</h1></header>\n` );
   wfs( `<h3>Properties</h3>\n` );
   wf( "+", 
      `<table>\n` );
   wfs( `<tr><TD> Type: </TD><TD> ${ characteristic }</TD></tr>\n` );

   if ( definition.UUID )
      wfs( `<tr><TD> UUID: </TD><TD> ${ definition.UUID }</TD></tr>\n` );

   if ( props.format )
      wfs( `<tr><TD> Format: </TD><TD> ${ props.format }</TD></tr>\n` );

   if ( props.unit )
      wfs( `<tr><TD> Unit: </TD><TD>  ${ props.unit }</TD></tr>\n` );

   if ( props.minValue )
      wfs( `<tr><TD> Min Value: </TD><TD>  ${ props.minValue }</TD></tr>\n` );

   if ( props.maxValue )
      wfs( `<tr><TD> Max Value: </TD><TD>  ${ props.maxValue }</TD></tr>\n` );

   if ( props.minStep )
      wfs( `<tr><TD> Min Step: </TD><TD>  ${ props.minStep }</TD></tr>\n` );

   if ( props.perms )
   {
      let output = "";
      let comma = "";
      props.perms.forEach( ( perm ) =>
      {
         switch( perm )
         {
            case "pr":
               output = output + comma + "Paired Read";
               break;
            case "pw":
               output = output + comma + "Paired Write";
               break;
            case "ev":
               output = output + comma + "Events";
               break;
            case "tw":
               output = output + comma + "Timed Write";
               break;
            case "wr":
               output = output + comma + "Write Response";
               break;
            default:
               console.log( "Unknown perm: %s", perm );
               process.exit(333);
         }
         comma = ", ";
      });
      wfs( `<tr><TD> Perms: </TD><TD>  ${ output }</TD></tr>\n` );

   }
   wf( "-", `</table>\n` );

   // Constants definition Table
   let defs = Object.keys( definition.validValues );
   if ( defs.length > 0 )
   {
      wfs( `<h3>Constants</h3>\n` );
      wf( "+", `<table>\n` );
      wfs( `<TD> Value </TD><TD> String </TD>\n` );

      defs.forEach( ( def ) =>
      {
        wfs( `<tr><TD> ${ definition.validValues[ def ] } </TD><TD> "${ def }" </TD></tr>\n` );
      });

      wf( "-", `</table>\n` );
   }

   // Verify Chsracteristic Notes
   let verify = definition.verifyCharacteristic;
   if ( verify )
   {
      wfs( `<h4>Note:</h4>\n` );
      wfs( `<note>Setting this characteristic will automstically trigger a "Get" of the characteristic: <a href="#${ verify.name }">${ verify.name }</a></note>\n` );

   }

   endDiv( characteristic ); // Closing DIV of Characteristic

}

function addCmd4DirectivePages_WithinMain( )
{
   // Start Directives div
   // The <div id> is used to show/hide the section.
   // The <class> is used for css formatting, including initial hide.
   // The <a name> is used to jump here when nav item clicked.
   wf( "+", `<div id="Directives" class="section">\n` );

   wfs( `<h2>CMD4 Directives</h2>\n` );
   wfs( `<p>These directives appear within the "Cmd4" plugin header and reflect how Cmd4 will behave overall.</p>\n` );


   wf( "+", `<TABLE WIDTH="100%">\n` );
   wfs( `<TR ALIGN="left"><TH>Cmd4Directive<TH>Type<TH PADDING="50px">Default<TH>Description</TR>\n` );

   // debug - CMD4 Directives
   wfs( `<TR ALIGN="left"><TD><a name="${ constants.DEBUG }_D">${ constants.DEBUG }</a><TD>  < Bool >  <TD>    false    <TD> Output Debug messages. Can also be accomplished with setenv DEBUG=${ settings.PLATFORM_NAME}</TR>\n` );

   // outputConstants - CMD4 Directives
   wfs( `<TR ALIGN="left"><TD><a name="${ constants.OUTPUTCONSTANTS }_D">${ constants.OUTPUTCONSTANTS }</a><TD>  < Bool >  <TD>    false    <TD> If Cmd4 will send Strings like "TRUE" or "FALSE" instead of 0 | 1 for all Accessories</TR>\n` );

   // statusMsg - CMD4 Directives - See cmd4Constants as why we do this
   let  defaultStatusMsg = constants.DEFAULT_STATUSMSG;
   wfs( `<TR ALIGN="left"><TD><a name="${ constants.STATUSMSG }_D"> ${ constants.STATUSMSG }</a><TD> < Bool > <TD> ${ defaultStatusMsg } <TD> Cmd4 will log a Set Status Message for all Accessories.</TR>\n` );

   // Interval - CMD4 Directives
   wfs( `<TR ALIGN="left"><TD><a name="${ constants.INTERVAL }_D"> ${ constants.INTERVAL }</a><TD> ${ constants.INTERVAL } <TD> ${ constants.DEFAULT_INTERVAL * .001 } < seconds > <TD> How long before killing the state command of all polled characteristics. See <a href="#${ constants.INTERVAL }" onclick="toggleVisibility( 'AccessoryDirectives');">${ constants.INTERVAL }</a> in Accessory Directives for full description as it can also be set per accessory or per characteristic.</TR>\n` );

   // Timeout - CMD4 Directives
   wfs( `<TR ALIGN="left"><TD><a name="${ constants.TIMEOUT }_D"> ${ constants.TIMEOUT }</a><TD> ${ constants.TIMEOUT } <TD> ${ constants.DEFAULT_TIMEOUT } < msec > <TD> How long before killing the state command of all polled characteristics. See <a href="#${ constants.TIMEOUT }" onclick="toggleVisibility( 'AccessoryDirectives');">${ constants.TIMEOUT }</a> in Accessory Directives for full description as it can also be set per accessory or per characteristic.</TR>\n` );

   // QueueTypes - CMD4 Directives
   wfs( `<TR ALIGN="left"><TD><a name="${ constants.QUEUETYPES }_D"> ${ constants.QUEUETYPES }</a><TD> < Array of { "${ constants.QUEUE }": < "SomeName" >, "${ constants.QUEUETYPE }": < "${ constants.QUEUETYPE_SEQUENTIAL }" | "${ constants.QUEUETYPE_WORM }" > "${ constants.QUEUE_RETRIES}": < ${ constants.DEFAULT_WORM_QUEUE_RETRY_COUNT } > } <TD> none <TD> Pre-defines Queue types. This Directive can also be per queue as noted by its presence as an accessory directive.</TR>\n` );

   // Definitions - Custom Characteristics - CMD4 Directives
   wfs( `<TR ALIGN="left"><TD><a name="${ constants.DEFINITIONS }_D"> ${ constants.DEFINITIONS }</a><TD> < Array > <TD> <TD> An Array of new Characteristic Objects. See <a href="#CUSTOM_CHARACTERISTICS" onclick="toggleVisibility( 'CustomCharacteristics');">Custom Characteristics, around line 339</a> for more information</TR>\n` );

   wf( "-", `</TABLE>\n` );
   endDiv( "main" );

}

function addCmd4AccessoryDirectivePages_WithinMain( )
{
   // Start AccessoryDirectives div
   // The <div id> is used to show/hide the section.
   // The <class> is used for css formatting, including initial hide.
   // The <a name> is used to jump here when nav item clicked.
   wf( "+", `<div id="AccessoryDirectives" class="section">\n` );

   wfs( `<h2><a name="CMD4 Accessory Directives">CMD4 Accessory Directives</a></h2>\n` );
   wfs( `<p>These directives appear within the characteristic section of the Cmd4 Accessory</p>\n` );

   wf( "+", `<TABLE WIDTH="100%" border: 1px solid black >\n` );
   wfs( `<TR cols="4" ALIGN="left"><TH>Cmd4Directive<TH>Type<TH PADDING="50px">Default<TH>Description</TR>\n` );

   // subType
   wfs( `<TR ALIGN="left"><TD><a name="${ constants.SUBTYPE }">${ constants.SUBTYPE }</a><TD> < unique string > <TD> accessory.name <TD> Used to distinguish accessories that have same Type and Name.</TR>\n` );

   // outputConstants - AccessoryDirectives
   wfs( `<TR ALIGN="left"><TD><a name="${ constants.OUTPUTCONSTANTS }">${ constants.OUTPUTCONSTANTS }</a><TD>  < Bool >  <TD>    false    <TD> If Cmd4 will send Strings like "TRUE" or "FALSE" instead of 0 | 1 </TR>\n` );

   // statusMsg - AccessoryDirectives
   let defaultStatusMsg = constants.DEFAULT_STATUSMSG;
   wfs( `<TR ALIGN="left"><TD><a name="${ constants.STATUSMSG }">${ constants.STATUSMSG }</a><TD>  < Bool >  <TD>  ${ defaultStatusMsg } <TD>Cmd4 will log a Set Status Message</TR>\n` );

   // publishExternally - AccessoryDirectives
   wfs( `<TR ALIGN="left"><TD><a name="${ constants.PUBLISHEXTERNALLY }">${ constants.PUBLISHEXTERNALLY }</a><TD>  < Bool >  <TD>    false     <TD> Tell Homebridge to publish the device as its own bridge. </TR>\n` );

   // stateChangeResponseTime - AccessoryDirectives
   wfs( `<TR ALIGN="left"><TD><a name="${ constants.STATECHANGERESPONSETIME }">${ constants.STATECHANGERESPONSETIME }</a><TD> < seconds > <TD> 60 <TD> How long to wait between a Set and Get command.</TR>\n` );

   // interval - AccessoryDirectives
   wfs( `<TR ALIGN="left"><TD><a name="${ constants.INTERVAL }">${ constants.INTERVAL }</a><TD> < seconds > <TD> ${ constants.DEFAULT_INTERVAL * .001 } < seconds > <TD> How long between polls of all polled characteristics.</TR>\n` );

   // timeout - AccessoryDirectives
   wfs( `<TR ALIGN="left"><TD><a name="${ constants.TIMEOUT }">${ constants.TIMEOUT }</a><TD> < msec > <TD> ${ constants.DEFAULT_TIMEOUT } < msec > <TD> How long before killing the state command of all polled characteristics.</TR>\n` );

   // polling - AccessoryDirectives
   wfs( `<TR ALIGN="left"><TD><a name="${ constants.POLLING }">${ constants.POLLING }</a><TD> < Bool > <TD> false <TD> If the characteristics should be polled for state change.</TR>\n` );

   wfs( `<TR><TD><TD COLSPAN=3> or  [{"characteristic" < characteristic >, [ "interval": < sec >, "timeout": < msec > ] }] The timeout and interval override any higher directive.</TR>\n` );

   // Queue - AccessoryDirectives
   wfs( `<TR ALIGN="left"><TD><a name="${ constants.QUEUE }"> ${ constants.QUEUE }</a><TD> ${ constants.QUEUE } <TD> < String > <TD> Defines which Queue polled characteristics will be placed.</TR>\n` );

   // state_cmd - AccessoryDirectives
   wfs( `<TR ALIGN="left"><TD><a name="${ constants.STATE_CMD }">${ constants.STATE_CMD }</a><TD>  < ${ constants.STATE_CMD } > <TD> See Description <TD> The command used to Get/Set Device characteristic State.</TR>\n` );
   wfs( `<TR><TD COLSPAN="4">The ${ constants.STATE_CMD } represents the path to your script. Cmd4 appends the Get/Set shown.<BR>\n` );
   wfs( `${ constants.STATE_CMD } Get < DisplayName > < characteristic ><BR>\n` );
   wfs( `${ constants.STATE_CMD } Set < DisplayName > < characteristic > < value ></TD></TR>\n` );

   // state_cmd_prefix - AccessoryDirectives
   wfs( `<TR ALIGN="left"><TD><a name="${ constants.STATE_CMD_PREFIX }">${ constants.STATE_CMD_PREFIX }</a><TD>  < String > <TD> <TD> A String prepended to the < ${ constants.STATE_CMD } >.</TR>\n` );

   // state_cmd_suffix - AccessoryDirectives
   wfs( `<TR ALIGN="left"><TD><a name="${ constants.STATE_CMD_SUFFIX }">${ constants.STATE_CMD_SUFFIX }</a><TD> < String > <TD> <TD> A String appended to the < ${ constants.STATE_CMD } >.</TR>\n` );

   // props - AccessoryDirectives
   wfs( `<TR ALIGN="left"><TD><a name="${ constants.PROPS }">${ constants.PROPS }</a><TD>  < Bool >  <TD>    false     <TD> A way to override Hap Characteristiic Properties<BR>\n` );
   wfs( `         Only used to set min/max temperatures, for instance:</TR>\n` );
   wfs( `<TR ALIGN="Left"><TD><TD COLSPAN=3>"${ constants.PROPS }" : { "currentTemperature": { "maxValue":100, "minValue": -100, "minStep": 0.1}}</TR>\n` );

   // category - AccessoryDirectives
   wfs( `<TR ALIGN="left"><TD><a name="${ constants.CATEGORY }">${ constants.CATEGORY }</a><TD> < CATEGORY > <TD> <TD> See <a href="https://developers.homebridge.io/#/categories">Homebridge Categories</a> for a complete list of possible categories.  </TR>\n` );

   // fakegato - AccessoryDirectives
   wfs( `<TR ALIGN="left"><TD><a name="${ constants.FAKEGATO }">${ constants.FAKEGATO }</a><TD>  < JSON >  <TD> <TD> See the section, <a href="https://github.com/ztalbot2000/homebridge-cmd4/docs/Developers.md#fakegatotag"> "Adding in Fakegato history"</a> below.</TR>\n` );

   // linkedTypes - AccessoryDirectives
   wfs( `<TR ALIGN="left"><TD><a name="${ constants.LINKEDTYPES }">${ constants.LINKEDTYPES }</a><TD>  < JSON >  <TD> <TD> Other Cmd4 Accessories like Input Source for HDMI inputs. </TR>\n` );


   wf( "-", `</TABLE>\n` );
   endDiv( "main" );

}

function addCustomCharacteristicPages_withinMain( )
{
   wf( "+", `<div id="CustomCharacteristics" class="section">\n` );

   wfs( `<h2><a name="CUSTOM_CHARACTERISTICS">Custom Characteristics</a></h2>\n` );
   wfs( `<p>These directives appear within the Cmd4 Platform section</p><BR>\n` );
   wfs( `<p>IMPORTANT - It is unlikely that adding custom characteristics will be supported by any GUI or SIRI<BR>\n` );
   wfs( `<BR><BR>\n` );
   wfs( `<p>Custom characteristics in Cmd4 do not stray far from how Homebridge uses them from HAP-NodeJS. To create a custom characteristic an object entry is programmatically added to <a href="https://github.com/ztalbot2000/homebridge-cmd4/blob/master/lib/CMD4_ACC_TYPE_ENUM.js">lib/CMD4_ACC_TYPE_ENUM.js</a> via an entry you define in your config.json. The best way to show how to define a custom characteristic is through an example</p>.\n` );
   wf( "+", `<pre>\n` );
   wfs( `{\n` );
   wfs( `   "platform": "Cmd4",\n` );
   wfs( `   "outputConstants": false,\n` );
   wfs( `   "statusMsg": true,\n` );
   wfs( `   "Definitions": [\n` );
   wfs( `      { "type": "PointX",\n` );
   wfs( `        "description": "An X Coordinate",\n` );
   wfs( `        "props": { "format": "uint32",\n` );
   wfs( `                   "minValue": 0,\n` );
   wfs( `                   "minStep": 1,\n` );
   wfs( `                   "perms": [ "ev", "pr", "pw" ]\n` );
   wfs( `                 }\n` );
   wfs( `      }\n` );
   wfs( `   ],\n` );
   wfs( `   "accessories": [\n` );
   wfs( `      { "type": "Switch",\n` );
   wfs( `        "name": "PS_4",\n` );
   wfs( `        "PointX": 3267,\n` );
   wfs( `        "on": false,\n` );
   wfs( `        "polling": [ { "characteristic": "on", "interval": 50 },\n` );
   wfs( `                     { "characteristic": "pointX", "interval": 5 }\n` );
   wfs( `                   ],\n` );
   wfs( `        "state_cmd": "node .homebridge/Cmd4Scripts/AnyDevice.js"\n` );
   wfs( `      }\n` );
   wfs( `   ]\n` );
   wfs( `}\n` );
   wf( "-", `</pre>\n` );
   wfs( `<BR><BR>\n` );
   wfs( `<p>The definitions for "props" can be found at: <a href="https://github.com/homebridge/HAP-NodeJS/blob/master/src/lib/Characteristic.ts">HAP Characteristics - line 259</a></p>\n` );



   endDiv( "CustomCharacteristics" );
}

function addScriptTemplatePages_WithinMain( )
{
   CMD4_SCRIPTS.forEach( ( script ) =>
   {
      addScriptPage_WithinMain( script );
   });
}

function addScriptPage_WithinMain( script )
{
   // Start script.link div
   // The <div id> is used to show/hide the section.
   // The <class> is used for css formatting, including initial hide.
   // The <a name> is used to jump here when nav item clicked.
   wf( "+", `<div id="${ script.link }" class="section">\n` );

   wfs( `<h2><a name="${ script.link }">${ script.description }</a></h2>\n` );
   // Create the full path to the file.
   let file = script.filePath +  script.file;

   wfs( `<p> This script is auto generated from: <a href=https://github.com/ztalbot2000/homebridge-cmd4/blob/master/${ file }>${ file } </a></p>\n` );
   wf( "+", `<pre>\n` );


   let readStream = fs.readFileSync( file, {encoding: 'utf8'} );
   w( readStream );

   wf( "-", `</pre>\n` );

   endDiv( "main" );
}

function endDiv( comment )
{
   let div = "</DIV>";
   if ( comment )
      div = div + `   <!-- ${comment} -->`;

   div = div + "\n";

   wf( "-" , div );
}


// Write to fid the given text, increasing or decreasing divLevel.
function wf( level, text )
{
   // Subtract now
   if ( level == "-" )
      divLevel--;

   fid.write( " ".repeat( divLevel * INDENT ).concat( text ) );

   // Add later 
   if (level == "+" )
      divLevel++;
}

// Convenience function for wfs. writing to same level.
function wfs( text )
{
   wf( "nc", text );
}
// Convenience function to write to fid, no formatting, as is.
function w( text )
{
   fid.write( text );
}

createHTMLCmd4AccDocument( );

if ( divLevel == 0)
{
   console.log( "Yahoo !  All lined up. " );
   return 0;
} else {
   console.log( "Booo ... alignment failed: %s", ['','+'][Number(divLevel > 0)] + divLevel );
}
return divLevel;
