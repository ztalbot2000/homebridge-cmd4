#!/usr/bin/node

// Notes:
// Schema definitions  https://json-schema.org/understanding-json-schema/structuring.html#the-id-property
// Schema              https://json-schema.org/understanding-json-schema/reference/generic.html#constant-values
// HB Example          https://github.com/oznu/homebridge-config-ui-x/wiki/Developers:-Plugin-Settings-GUI
// Angular Online test https://hamidihamza.com/ajsf/?framework=bootstrap-4
// HomeBridge Example  https://github.com/AlexGustafsson/homebridge-wol/blob/master/config.schema.json

// Cmd4 Constants and Settings
const constants = require( "../cmd4Constants" );
const settings = require( "../cmd4Settings" );


const which = require('which');
const path = require( "path" );
const chalk = require( "chalk" );

// Get the real path of homebridge instead of a dev dependancy,
// which caused issues if you forget to update dependancies but
// upgrade homebridge.
const homebridgePath = which.sync( 'homebridge', { nothrow: true } )

const schemaVersionSupport = 6;

let apiPath;
let HomebridgeAPI;
if ( homebridgePath )
{
   let dirname = path.dirname( homebridgePath );

   console.log( "Found homebridge in path %s", dirname );
   apiPath = `${ dirname }/../lib/node_modules/homebridge/lib/api`;
   HomebridgeAPI = require( apiPath ).HomebridgeAPI;

   if ( ! HomebridgeAPI )
   {
      console.log( "homebridgeAPI not available !!!" );
      process.exit( 10 );
   }

} else
{
   console.log( "homebridge not found !!!" );
   process.exit( 10 );
}
console.log( "Found api in %s", apiPath );

let _api = new HomebridgeAPI( ); // object we feed to Plugins
let Characteristic = _api.hap.Characteristic;
let Service = _api.hap.Service;
let Categories = _api.hap.Categories;
let Formats = Characteristic.Formats;

// These would be the uninitialized values.
let ACC_DATA = require("../lib/CMD4_ACC_TYPE_ENUM");
let DEVICE_DATA = require("../lib/CMD4_DEVICE_TYPE_ENUM");

// Init the library for all to use
let CMD4_ACC_TYPE_ENUM = ACC_DATA.init( Characteristic );
let CMD4_DEVICE_TYPE_ENUM = DEVICE_DATA.init( CMD4_ACC_TYPE_ENUM, Service, Characteristic, Categories );

// Fan, Faucet, Switch, TELEVISION
//let devices = [ 18, 21, 51, 54 ];
// Fan
let devices = [ 18 ];

// File System utilities
let fs = require( "fs" );

var fid;

var bracketLevel=0;
const INDENT = 3;
var commaRequired = false;

// For now, put in /tmp
let CMD4_SCHEMA_FILE = "config.schema.json";


function createSchemaFile( )
{
   let dirname = path.dirname( homebridgePath );

   // All this screwing around with the path is because on M1 Mac, its
   // totally different and can only find it relative to `which homebridge`
   let schemaFile = `${ dirname }/../lib/node_modules/homebridge-cmd4/${ CMD4_SCHEMA_FILE }`;

   console.log( chalk.blue( `Creating schema file: ${ schemaFile }` ) );
   // Open the Schema file for writing
   fid = fs.openSync( schemaFile, 'w' );

   if ( fid < 0 )
   {
        console.log( `Error openSync ${ schemaFile } err ${ fid }` );
        process.exit( fid );
   }


   commaRequired = false;
   addSchemaHeader( );

   startSchema( );

   addDefinitionsBlock( );

   addReferencesBlock( );

   endBracketSchema( );

   addLayout( );

   closeSchemaDocument( );

}
//
// Write the beginning blurb
//
function  addSchemaHeader( )
{
   // add the comma always next time.
   if ( commaRequired == true )
      w( `,\n` );

   // Begin bracket JSON
   wf( "+", `{\n` );

   // pluginAlias: The plugin identifier.
   wfs( `"pluginAlias": "${ settings.PLATFORM_NAME }",\n` );

   // pluginType: The type of plugin, valid values are platform or accessory.
   wfs( `"pluginType": "platform",\n` );

   // headerDisplay: Additional content in the user interface above the config form.
   wfs( `"headerDisplay": "Cmd4 Add Accessories",\n` );

   // footerDisplay: Additional content in the user interface below the config form.
   // wfs( `"footerDisplay": "A Sample Footer for Cmd4",\n` );

   // singular: If set to true the UI will not allow the user to add
   // more than one config block. This is usually used for platform
   // plugins where only a single config block should be present.
   wfs( `"singular": "false"` );

   commaRequired = true;
}

function startSchema( )
{
   // add the comma always next time.
   if ( commaRequired == true )
      w( `,\n` );

   // * Begin bracket Schema
   wf( "+", `"schema": {\n` );
   //wfs ( `"schema": "https://json-schema.org/draft/2020-12/schema",\n`);

   commaRequired = false;
}

function addAccessoryTypeDesignationDefinitionBlock( )
{
   // add the comma always next time.
   if ( commaRequired == true )
      w( `,\n` );

   wfs( `"$comment": "START OF TYPE DEFINITION",\n` );
   // *** Begin bracket Type designation definition
   wf( "+", `"Type_designation": {\n` );
      wfs( `"$id": "#Type_designation",\n` );
      wfs( `"type": "string",\n` );
      wfs( `"title": "${ constants.TYPE }",\n` );
      wfs( `"description": "Select the Accessory Type.",\n` );
      //wfs( `"default": "Switch",\n` );
      // **** Begin square bracket oneOf for "type"
      wf( "+", `"oneOf": [\n` );
         //wfs( `{ "title": "Switch", "enum": ["Switch"] },\n` );

         // Over the Cmd4 Devices
         let deviceCommaRequired = false;
         for ( let index=0; index < CMD4_DEVICE_TYPE_ENUM.EOL; index ++)
         //for ( let j=0; j < devices.length; j++ )
         {
             if ( deviceCommaRequired == true )
                 w(",\n");

             //let index = devices[ j ];
             let deviceName = CMD4_DEVICE_TYPE_ENUM.properties[ index ].deviceName;
             wfs( `{ "title": "${ deviceName }", "enum": ["${ deviceName }"] }` );

             deviceCommaRequired = true ;
         }
         w( "\n" );
      wf( "-", `],\n`, "end square bracket oneOf" );
      wfs( `"required": true\n` );
   wf( "-", `}`, "end bracket Type designation" );

   commaRequired = true;
}

function addNameDesignationDefinitionBlock( )
{
   // add the comma always next time.
   if ( commaRequired == true )
      w( `,\n` );

   wfs( `"$comment": "START OF NAME DEFINITION",\n` );
   // *** Begin bracket name definition
   // Since name is also a characteristic add "_designation" delimiter
   wf( "+", `"Name_designation": {\n` );
      wfs( `"$id": "#Name_designation",\n` );
      wfs( `"title": "${ constants.NAME }",\n` );
      wfs( `"type": "string",\n` );
      wfs( `"minLength": 1,\n` );
      wfs( `"required": true\n` );
   // *** End bracket Name designation definition
   wf( "-", `}` );

   commaRequired = true;
}

function addPollingBoolDesignationDefinitionBlock( )
{
   // add the comma always next time.
   if ( commaRequired == true )
      w( `,\n` );

   wfs( `"$comment": "START OF POLLING BOOL DEFINITION",\n` );
   // *** Begin bracket Polling designation definition
   wf( "+", `"Polling_designation": {\n` );
      wfs( `"$id": "#Polling_designation",\n` );
      wfs( `"title": "${ constants.POLLING }",\n` );
      wfs( `"type": "boolean",\n` );
      wfs( `"required": false,\n` );
      // *** Begin bracket condition
      wf( "+", `"condition": {\n` );
        wfs( `"functionBody": "return model.${ constants.TYPE } && model.${ constants.TYPE } !== 'null';"\n` );
      // *** End bracket condition
      wf( "-", `},\n` );
      wfs( `"description": "If Polling should be done"\n` );
   // *** End bracket Polling designation definition
   wf( "-", `}` );

   commaRequired = true;
}

function addStateCmdDesignationDefinitionBlock( )
{
   // add the comma always next time.
   if ( commaRequired == true )
      w( `,\n` );

   wfs( `"$comment": "START OF STATE_CMD DEFINITION",\n` );
   // *** Begin bracket State_cmd designation definition
   wf( "+", `"StateCmd_designation": {\n` );
      wfs( `"$id": "#StateCmd_designation",\n` );
      wfs( `"title": "${ constants.STATE_CMD }",\n` );
      // *** Begin bracket condition
      wf( "+", `"condition": {\n` );
        wfs( `"functionBody": "return model.Polling_designation && model.Polling_designation == true;"\n` );
      // *** End bracket condition
      wf( "-", `},\n` );
      wfs( `"type": "string",\n` );
      wfs( `"required": true,\n` );
      wfs( `"description": "The command to query devices state"\n` );
   // *** End bracket StateCmd designation definition
   wf( "-", `}` );

   commaRequired = true;
}

function addDeviceDefinitionsBlock(  )
{
   // add the comma always next time.
   if ( commaRequired == true )
      w( `,\n` );

   // Name Definition

   wfs( `"$comment": "START OF REQUIRED CHARACTERISTIC DEFINITIONS",\n` );
   // Over the Cmd4 Devices, create pre-definitions
   let deviceCommaRequired  = false;
   //for ( let j=0; j < devices.length; j++ )
   //for ( let index=0; index < CMD4_DEVICE_TYPE_ENUM.EOL; index ++ )
   for ( let index=51; index < 52; index ++ )
   {
      // What it is supposed to look like
      //"Brightness":
      // {
      //      "type": "int",
      //      "description": "used to set Brightness (range 0-100)",
      //      "condition": {
      //          "functionBody": "return [ 'Switch', 'LightBulb' ].includes(model.Type);"
      //      }
      // },

      let devProperties = CMD4_DEVICE_TYPE_ENUM.properties[ index ];

      // add the comma always next time.
      if ( deviceCommaRequired == true )
         w( `,\n` );


      if ( devProperties.requiredCharacteristics.length > 0 )
      {
         wf( "+", `"${ devProperties.deviceName }_required": {\n` );
            wfs( `"$id": "#${ devProperties.deviceName }_required",\n` );
            wfs( `"type": "fieldset",\n` );
            wfs( `"title": "Required Characteristics",\n` );
               // *** Begin bracket condition
               wf( "+", `"condition": {\n` );
                 wfs( `"functionBody": "return model.${ constants.TYPE } && model.${ constants.TYPE } === '${ devProperties.deviceName }';"\n` );
               // *** End bracket condition
               wf( "-", `},\n` );

            let characteristicCommaRequired = false;

            // **** Begin square bracket items
            wf( "+",`"items": [\n` );
               for ( let index = 0; index < devProperties.requiredCharacteristics.length; index++ )
               {
                  if ( characteristicCommaRequired == true )
                     w( `,\n` );

                  let accTypeEnumIndex = devProperties.requiredCharacteristics[ index ].type;
                  let characteristicString = CMD4_ACC_TYPE_ENUM.properties[ accTypeEnumIndex ].type;
                  let defaultValue = devProperties.requiredCharacteristics[ index ].defaultValue;
                  wfs( `{ "${ characteristicString }": { "$ref": "#/definitions/${ characteristicString }" } }` );

                  characteristicCommaRequired = true;
               }
               w( `\n` );
            // **** End square bracket items
            wf( "-", `]\n` );
         // *** End bracket device definition
         wf( "-", `}` );
      }

      deviceCommaRequired = true;

   }

   commaRequired = true;
}

function addCharacteristicDefinitionBlock( )
{
   // add the comma always next time.
   if ( commaRequired == true )
      w( `,\n` );

   wfs( `"$comment": "START OF CHARACTERISTIC DEFINITIONS",\n` );
   // Over the Cmd4 Characteristics, create pre-definitions
   let characteristicCommaRequired = false;
   Object.keys( CMD4_ACC_TYPE_ENUM.properties).forEach( ( accKey ) =>
   {
      let accRecord = CMD4_ACC_TYPE_ENUM.properties[ accKey ];

      let characteristicString = accRecord.type;
      let description = accRecord.description;

      // add the comma always next time.
      if ( characteristicCommaRequired == true )
         w( `,\n` );

      // *** Begin bracket characteristic definition
      wf( "+", `"${ characteristicString }": {\n` );
         wfs( `"$id": "#${ characteristicString }",\n` );
         wfs( `"title": "${ characteristicString }",\n` );
         switch ( accRecord.props.format )
         {
            case Formats.BOOL:
               wfs( `"type": "boolean",\n` );
               break;
            case Formats.INT:
            case Formats.UINT8:
            case Formats.UINT16:
            case Formats.UINT32:
            case Formats.UINT64:
              wfs( `"type": "integer",\n` );
              break;
            case Formats.FLOAT:
              wfs( `"type": "number",\n` );
              break;
            case Formats.STRING:
              wfs( `"type": "string",\n` );
              break;
            case Formats.DATA:
            case Formats.TLV8:
            case Formats.DICT:
              wfs( `"type": "string",\n` );
              break;
            default:
               console.log( `unhandled type: ${ accRecord.format }` );
               exit -1;
         }

         if ( accRecord.props.maxValue != undefined )
            wfs( `"maximum": ${ accRecord.props.maxValue },\n` );

         if ( accRecord.props.minValue != undefined )
            wfs( `"minimum": ${ accRecord.props.minValue },\n` );

         // THIS MAY ALL NOT BE NEEDED AS WILL BE PART OF DEVICE LAYOUT
         let deviceCommaRequired  = false;
         let conditionStarted  = false;
         Object.keys( CMD4_DEVICE_TYPE_ENUM.properties).forEach( ( devKey ) =>
         {
            let devRecord = CMD4_DEVICE_TYPE_ENUM.properties[ devKey ];

            devRecord.requiredCharacteristics.forEach( ( required ) =>
            {
               if ( required.type == accKey )
               {
                  if ( conditionStarted == false )
                  {
                     wf( "+", `"condition": {\n`);
                     wfs(`"functionBody": "return [ `);
                     conditionStarted = true;
                  }
                  let deviceString = devRecord.deviceName;
                  // add the comma always next time.
                  if ( deviceCommaRequired == true )
                     w( `, ` );

                  w(`'${ deviceString }'`);
                  deviceCommaRequired = true;
               }
            });
         });
         if ( conditionStarted == true )
         {
            w( `].includes(model.Type);"\n`);
            wf( "-", `},\n` );
         }
         wfs( `"description": " ${ description }"\n` );
         // *** End bracket characteristic definition
      wf( "-", `}` );

      characteristicCommaRequired = true;
   });

   commaRequired = true;
}

function addRequiredCharacteristicDefinitionBlock( )
{
   // add the comma always next time.
   if ( commaRequired == true )
      w( `,\n` );

   wfs( `"$comment": "START OF REQUIRED CHARACTERISTIC DEFINITIONS",\n` );
   // Over the Cmd4 Devices, create pre-definitions
   let deviceCommaRequired  = false;
   for ( let index=0; index < CMD4_DEVICE_TYPE_ENUM.EOL; index ++ )
   {
      let devProperties = CMD4_DEVICE_TYPE_ENUM.properties[ index ];

      // add the comma always next time.
      if ( deviceCommaRequired == true )
         w( `,\n` );

      if ( devProperties.requiredCharacteristics.length > 0 )
      {
         wf( "+", `"${ devProperties.deviceName }_required": {\n` );
            wfs( `"$id": "#${ devProperties.deviceName }_required",\n` );
            wfs( `"type": "fieldset",\n` );
            wfs( `"title": "Required Characteristics",\n` );
               // *** Begin bracket condition
               wf( "+" `"condition": {\n` );
                 wfs( `"functionBody": "return model.${ constants.TYPE } && model.type == '${ devproperties.deviceName }';"\n` );
               // *** End bracket condition
               wf( "-", `},\n` );

            let characteristicCommaRequired = false;

            // **** Begin square bracket items
            wf( "+",`"items": [\n` );
               for ( let index = 0; index < devProperties.requiredCharacteristics.length; index++ )
               {
                  if ( characteristicCommaRequired == true )
                     w( `,\n` );

                  let accTypeEnumIndex = devProperties.requiredCharacteristics[ index ].type;
                  let characteristicString = CMD4_ACC_TYPE_ENUM.properties[ accTypeEnumIndex ].type;
                  let defaultValue = devProperties.requiredCharacteristics[ index ].defaultValue;
                  wfs( `"${ characteristicString }"` );

                  characteristicCommaRequired = true;
               }
               w( `\n` );
            // **** End square bracket items
            wf( "-", `]\n` );
         // *** End bracket device definition
         wf( "-", `}` );
      }

      deviceCommaRequired = true;
   }

   commaRequired = true;
}

function addDefinitionsBlock( )
{
   // add the comma always next time.
   if ( commaRequired == true )
      w( `,\n` );

   // ** Begin bracket definitions
   wf( "+", `"definitions": {\n` );

      commaRequired = false;
      addCharacteristicDefinitionBlock( );
      // breaks homebridge
      //addRequiredCharacteristicDefinitionBlock( );
      addNameDesignationDefinitionBlock( );
      addPollingBoolDesignationDefinitionBlock( );
      addStateCmdDesignationDefinitionBlock( );
      addAccessoryTypeDesignationDefinitionBlock( );
      addDeviceDefinitionsBlock();

   // ** End bracket definitions
   w( `\n` );
   wf( "-", `}` );

   commaRequired = true;
}






function startProperties( )
{
   // add the comma always next time.
   if ( commaRequired == true )
      w( `,\n` );

   // ** Begin bracket properties
   wfs( `"type": "object",\n` );
   wf( "+", `      "properties": {\n` );

   commaRequired = false;
}

function addReferencesBlock( )
{
   // IMPORTANT
   // When an Layout Item references a definition, this is the cross
   // reference between it and the actual definition. Providing this
   // reference shows the min/max/format/description of the definition

   // add the comma always next time.
   if ( commaRequired == true )
      w( `,\n` );

   // ** Begin bracket properties
   wfs( `"type": "object",\n` );
   wf( "+", `"properties": {\n` );
      wfs( `"${ constants.TYPE }": { "$ref": "#/definitions/Type_designation"}` );

      Object.keys( CMD4_ACC_TYPE_ENUM.properties).forEach( ( accKey ) =>
      {
         // add comma for this record.
         w( `,\n` );

         let accRecord = CMD4_ACC_TYPE_ENUM.properties[ accKey ];

         let characteristicString = accRecord.type;
         wfs( `"${ characteristicString }": { "$ref": "#/definitions/${ characteristicString }"}` );
      });
      w( `,\n` );
      wfs( `"Polling_designation": { "$ref": "#/definitions/Polling_designation"},\n` );
      wfs( `"StateCmd_designation": { "$ref": "#/definitions/StateCmd_designation"}\n` );


   // *** End bracket type:
   wf( "-", `}\n` );

   commaRequired = true;
}


// $$$$$$$$$$$$$$$$$$$$$$$$$$$$

function endBracketProperties( )
{
   // add the comma always next time.
   if ( commaRequired == true )
      w( `,\n` );

   // * End bracket Properties
   wf( "-", `}\n` );

   commaRequired = true;
}

function endBracketSchema( )
{
   // * End bracket Schema
   wf( "-", `}` );

   commaRequired = true;
}

function addDevicesToLayout()
{
   Object.keys( CMD4_DEVICE_TYPE_ENUM.properties).forEach( ( devKey ) =>
   {
      // add the comma always next time.
      if ( commaRequired == true )
         w( `,\n` );

      let devRecord = CMD4_DEVICE_TYPE_ENUM.properties[ devKey ];
      let deviceString = devRecord.deviceName;

      wf( "+", `{\n` );
         wfs( `"type": "fieldset",\n` );
         wfs( `"expandable": true,\n` );
         wfs( `"title": "Required (Initial Values)",\n` );
         wf( "+", `"condition": {\n` );
            wfs( `"functionBody": "return model.Type && model.Type === '${ deviceString }';"\n` );
         wf( "-", `},\n` );


         itemsStarted = false;
         devRecord.requiredCharacteristics.forEach( ( required ) =>
         {
            // add the comma always next time.
            if ( itemsStarted == true )
               w( `,` );

            if ( itemsStarted == false )
            {
               wfs( `"items": `);
               w( `[` );
               itemsStarted = true;
            }
            let accTypeEnumIndex = required.type;
            let characteristicString = CMD4_ACC_TYPE_ENUM.properties[ accTypeEnumIndex ].type;
            w(` "${ characteristicString }"`);

         });

         w( ` ]\n` );
      wf( "-", `}` );
   });

   commaRequired = true;
}

function addLayout( )
{
   // add the comma always next time.
   if ( commaRequired == true )
      w( `,\n` );

   // * Begin square bracket layout:
   wf( "+", `"layout": [\n` );
      wf( "+", `"${ constants.TYPE }", {\n` );
         wfs( `"key": "name",\n` );
         wf( "+", `"condition": {\n` );
            wfs( `"functionBody": "return model.Type && model.Type !== 'null';"\n` );
         wf( "-", `}\n` );
      // * End bracket Type:
      wf( "-", `}` );
      commaRequired = true;

      addDevicesToLayout();

      if ( commaRequired == true )
         w( ",\n" );

      wfs( `"Polling_designation",\n` );
      wfs( `"StateCmd_designation"` );

      if ( commaRequired == true )
         w( "\n" );

   // * End square bracket layout:
   wf( "-", `]` );

   commaRequired = true;
}

function closeSchemaDocument( )
{
   if ( commaRequired == true )
      w( "\n" );

   // End bracket JSON
   wf( "-", `}\n` );

   // Close the Schema file
   fs.closeSync( fid );
}


// Write to fid the given text, increasing or decreasing bracketLevel.
function wf( level, text )
{
   if ( level != "+" && level != "-" && level != "nc" )
   {
      console.log( chalk.red( `Error, level must be "+" | "-" | "nc" but received, "${ level }"` ) );
      process.exit( 1 );
   }
   // Subtract now
   if ( level == "-" )
      bracketLevel--;

   // Check that bracketLevel is valid.
   // Don't exit as the traceback generated when repeat fails is important.
   if ( bracketLevel < 0 )
   {
      console.log( chalk.red( `Too many closed brackets: ${ bracketLevel }` ) );
   }

   fs.writeSync( fid, " ".repeat( bracketLevel * INDENT ).concat( text ) );

   // Add later
   if ( level == "+" )
      bracketLevel++;
}

// Convenience function for wfs. writing to same level.
function wfs( text )
{
   // Ignore comments that are only available in version 7+
   if ( schemaVersionSupport <= 6 && text.startsWith( `"$comment"` ) )
   {
      // nc
   } else
   {
      if ( text.charAt( 0 ) == "+" || text.charAt( 0 ) == "-" )
         console.log( chalk.yellow( `Warning: wfs called with +/- as first character. Usually you meant to call "wf" instead and this may be causing a bracket alignment error further below.` ) );
      wf( "nc", text );
   }
}
// Convenience function to write to fid, no formatting, as is.
function w( text )
{
   fs.writeSync( fid, text );
}

createSchemaFile( );


if ( bracketLevel == 0)
{
   console.log( "Yahoo !  All lined up. " );
   return 0;
} else {
   console.log( "Booo ... alignment failed: %s", ['','+'][Number(bracketLevel > 0)] + bracketLevel );
}
return bracketLevel;
